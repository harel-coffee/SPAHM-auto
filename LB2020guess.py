import numpy
import pyscf.data, pyscf.df

class LB2020guess:

  acfile_default  = './parameters_HF.dat'

  def __init__(self, fname=None):
    self.get_basis(fname)

  def renormalize(self, a):
    # 1/norm1 = \int \exp(-a*r^2) d^3 r       => norm1 = (a/pi)^(3/2)
    # 1/norm2^2 = \int (\exp(-a*r^2))^2 d^3 r => norm2 = (2.0*a/pi)^(3/4)
    # coefficient = norm1 / norm2 = (0.5*a/pi)^(3/4)
    x = numpy.sqrt(numpy.sqrt(0.5*a/numpy.pi))
    return x*x*x

  def read_ac(self, fname):
    if fname==None:
      fname = self.acfile_default
    with open(fname) as f:
      lines = f.readlines()
    basis = {'H': []}
    il=0
    while il<len(lines):
      q,ng = map(int,lines[il].split())
      il+=1
      qbasis = []
      for ig in range(ng):
        a,c = map(float,lines[il].split())
        qbasis.append([0,[a, c*self.renormalize(a)]])
        il+=1
      basis[pyscf.data.elements.ELEMENTS[q]] = qbasis
    return basis

  def add_caps(self, basis):
    caps_array = numpy.zeros(103)
    caps_array  [  1 :   2 +1] = 1.0 /  3.0,
    caps_array  [  3 :   4 +1] = 1.0 / 16.0,
    caps_array  [  5 :  10 +1] = 1.0 /  3.0,
    caps_array  [ 11 :  12 +1] = 1.0 / 32.0,
    caps_array  [ 13 :  18 +1] = 1.0 /  8.0,
    caps_array  [ 19 :  20 +1] = 1.0 / 32.0,
    caps_array  [ 21 :  30 +1] = 1.0 /  6.0,
    caps_array  [ 31 :  36 +1] = 1.0 / 12.0,
    caps_array  [ 37 :  38 +1] = 1.0 / 32.0,
    caps_array  [ 39 :  48 +1] = 1.0 /  8.0,
    caps_array  [ 49 :  54 +1] = 1.0 / 12.0,
    caps_array  [ 55 :  70 +1] = 1.0 / 32.0,
    caps_array  [ 71 :  86 +1] = 1.0 / 12.0,
    caps_array  [ 87 : 102 +1] = 1.0 / 32.0
    for q in range(1,103):
      a = caps_array[q]
      basis[pyscf.data.elements.ELEMENTS[q]].append( [0, [a, self.renormalize(a) ]] )
    return basis

  def get_basis(self, fname):
    if 0:
      acbasis = self.read_ac(fname)
      self.add_caps(acbasis)
      self.acbasis = acbasis
    else:
      self.acbasis =\
{'H': [[0, [0.3333333333333333, 0.11054119563683354]]],
'He': [[0, [1.8865345899608519, 0.4056146926108746]], [0, [0.3333333333333333, 0.11054119563683354]]],
'Li': [[0, [1.9854870701524918, 0.842937532901041]], [0, [0.0625, 0.03149742944229759]]],
'Be': [[0, [4.744586184977778, 1.3574437702689057]], [0, [0.2792470137084066, 0.12818229520909]], [0, [0.0625, 0.03149742944229759]]],
'B': [[0, [6.0338581393756145, 2.094637525409216]], [0, [0.2296652845463048, 0.1538820056563987]], [0, [0.3333333333333333, 0.11054119563683354]]],
'C': [[0, [8.36842382629919, 2.912335066987576]], [0, [0.3175823851018592, 0.2825906903498745]], [0, [0.3333333333333333, 0.11054119563683354]]],
'N': [[0, [10.93399949627562, 3.848864491590766]], [0, [0.43457823405570917, 0.4666119106370673]], [0, [0.3333333333333333, 0.11054119563683354]]],
'O': [[0, [13.822779569568999, 4.823227937581987]], [0, [0.6163807631542392, 0.7589805047258943]], [0, [0.3333333333333333, 0.11054119563683354]]],
'F': [[0, [16.696221288447184, 5.913626376015676]], [0, [0.8069674335184295, 1.1067332169360984]], [0, [0.3333333333333333, 0.11054119563683354]]],
'Ne': [[0, [19.44766524633368, 7.113317051280908]], [0, [1.0081157441421305, 1.508827408605945]], [0, [0.3333333333333333, 0.11054119563683354]]],
'Na': [[0, [22.043514485429395, 8.505970515543133]], [0, [1.0688208368282481, 1.7698621680543754]], [0, [0.03125, 0.018728483598538237]]],
'Mg': [[0, [35.68089579776235, 9.370720219473146]], [0, [2.9023990296953044, 2.762905547578002]], [0, [0.391911845854857, 0.4395524604043637]], [0, [0.03125, 0.018728483598538237]]],
'Al': [[0, [34.328377368288, 11.458430900825965]], [0, [1.895391976451897, 2.8294008855907764]], [0, [0.12243916188522636, 0.09609543557391674]], [0, [0.125, 0.052972151015469704]]],
'Si': [[0, [40.1763529442365, 13.078588758018803]], [0, [2.239495255980109, 3.340046848460941]], [0, [0.13204220229571037, 0.13836780632028686]], [0, [0.125, 0.052972151015469704]]],
'P': [[0, [46.66493733746877, 14.784964733718208]], [0, [2.6279568276824814, 3.8907484994126014]], [0, [0.1594036030260791, 0.2054997181258127]], [0, [0.125, 0.052972151015469704]]],
'S': [[0, [54.215297785332154, 16.531442577888246]], [0, [3.167647315145373, 4.489750969396064]], [0, [0.22671769463490918, 0.3487263502408896]], [0, [0.125, 0.052972151015469704]]],
'Cl': [[0, [62.03053259370884, 18.377558847158248]], [0, [3.700397336007754, 5.10183267645642]], [0, [0.28974576291563425, 0.5086598918385119]], [0, [0.125, 0.052972151015469704]]],
'Ar': [[0, [70.09781762916084, 20.327210911919742]], [0, [4.219331463603571, 5.7261201541458835]], [0, [0.35198503878294074, 0.6852541804555327]], [0, [0.125, 0.052972151015469704]]]}

  def HLB20(self, mol):
    auxmol = pyscf.df.make_auxmol(mol, self.acbasis)
    pmol  = mol + auxmol
    eri3c = pmol.intor('int3c2e_sph', shls_slice=(0,mol.nbas,0,mol.nbas,mol.nbas,mol.nbas+auxmol.nbas))
    eri3c = eri3c.reshape(mol.nao_nr(), mol.nao_nr(), -1)
    iao = 0
    for iat in range(auxmol.natm):
      q = auxmol._atom[iat][0]
      for prim in auxmol._basis[q]:
        eri3c[:,:,iao] *= prim[1][1]
        iao+=1
    return numpy.einsum('pqi->pq', eri3c)

  def Heff(self, mol):
    self.mol = mol
    self.Hcore = mol.intor('int1e_nuc_sph') + mol.intor('int1e_kin_sph')
    self.Heff = self.Hcore + self.HLB20(mol)
    return self.Heff

